{% import "@SyliusShop/Common/Macro/money.html.twig" as money %}

{% set itemsSubtotal = sylius_order_items_subtotal(cart) %}
{% set taxIncluded = sylius_order_tax_included(cart) %}
{% set taxExcluded = sylius_order_tax_excluded(cart) %}

{% set subtotal = itemsSubtotal %}
{% if cart.orderPromotionTotal %}
    {% set subtotal = itemsSubtotal + cart.orderPromotionTotal %}
{% endif %}

{% set bonusPointsAdjustment = constant('BitBag\\SyliusBonusPointsPlugin\\Entity\\AdjustmentInterface::ORDER_BONUS_POINTS_ADJUSTMENT') %}

{% set bonusPointsTotal = cart.getAdjustmentsTotal(bonusPointsAdjustment) %}

<div class="totals card mb-3 position-sticky">
    {{ sonata_block_render_event('sylius.shop.cart.summary.totals', {'cart': cart}) }}

    <div class="d-flex flex-column py-3 px-0 px-lg-4 col-11 col-md-10 col-lg-12 mx-auto">
        <div class="d-flex justify-content-between">
            <span>{{ 'sylius.ui.items_total'|trans }}</span>
            <span>{{ money.convertAndFormat(subtotal - taxIncluded) }}</span>
        </div>

        <div class="d-flex justify-content-between">
            <span>{{ 'sylius.ui.tva_20'|trans }}</span>
            {% if not taxIncluded and not taxExcluded %}
                <span>{{ money.convertAndFormat(0) }}</span>
            {% endif %}
            {% if taxExcluded %}
                <span>{{ money.convertAndFormat(taxExcluded) }}</span>
            {% endif %}
            {% if taxIncluded %}
                <span>{{ money.convertAndFormat(taxIncluded) }}</span>
            {% endif %}
        </div>

        <div class="d-flex justify-content-between mt-3">
            <span>
                {{ 'sylius.ui.global_amount'|trans }}<br>
                <small>{{ 'sylius.ui.without_shipping'|trans }}</small>
            </span>
            <div>
                {% if cart.orderPromotionTotal %}
                    <span class="mr-2 position-relative subtotal-strike"><span></span>{{ money.convertAndFormat(itemsSubtotal) }}</span>
                {% endif %}
                <span>{{ money.convertAndFormat(subtotal) }}</span>
            </div>
        </div>

        <div class="total-separator w-75 mx-auto mt-3 mb-2"></div>

        <div class="d-flex flex-column">
            <span class="text-muted mb-2">{{ 'sylius.ui.discount_code_cannot_be_combined'|trans }}</span>
            <div class="coupon-input input-group mb-2 mr-sm-2">
                <input type="text" placeholder="{{ 'sylius.ui.add_discount_code'|trans }}" class="coupon-code form-control w-100" />
                <div class="input-group-append">
                    <button class="btn input-group-text coupon-code-btn"><i class="fas fa-long-arrow-alt-right"></i></button>
                </div>
            </div>
            <span class="coupon-error px-2"></span>
        </div>

        {% if cart.orderPromotionTotal %}
            <div class="d-flex justify-content-between">
                {% set couponCode = '' %}
                {% if cart.promotionCoupon != null %}
                    {% set couponCode = cart.promotionCoupon.code %}
                {% endif %}
                <span>{{ 'sylius.ui.discount'|trans({'%s': couponCode}) }}</span>
                <span class="promotion-amount">{{ money.convertAndFormat(cart.orderPromotionTotal) }}</span>
            </div>
        {% endif %}

        <div class="total-separator w-75 mx-auto mt-3 mb-2"></div>

        {% if bitbag_active_bonus_points() > 0 %}
            <div class="d-flex flex-column">
                <div class="mb-2">
                    <span class="text-muted">{{ 'bitbag_sylius_bonus_points.ui.you_have_bonus_points_available'|trans }}</span>
                    <strong>{{ (bitbag_active_bonus_points() / 100)|round(0, 'floor') }}&euro;</strong>
                </div>

                <div class="bonus-points-input input-group mb-2 mr-sm-2{% if bonusPointsTotal %} d-none{% endif %}">
                    <input type="text" placeholder="{{ 'bitbag_sylius_bonus_points.ui.use_bonus_points'|trans }}" class="bonus-points form-control w-100" />
                    <div class="input-group-append">
                        <button class="btn input-group-text bonus-points-btn"><i class="fas fa-long-arrow-alt-right"></i></button>
                    </div>
                </div>
                <span class="bonus-points-error px-2{% if bonusPointsTotal %} d-none{% endif %}"></span>
            </div>

            {% if bonusPointsTotal %}
                <div class="d-flex justify-content-between">
                    <div>
                        <span>{{ 'bitbag_sylius_bonus_points.ui.bonus_points_total_used'|trans }}</span>
                        (<a class="delete-bonus-points">{{ 'bitbag_sylius_bonus_points.ui.bonus_points_delete_link'|trans }}</a>)
                    </div>
                    <span class="promotion-amount">{{ money.convertAndFormat(bonusPointsTotal) }}</span>
                </div>
            {% endif %}
            <div class="total-separator w-75 mx-auto mt-3 mb-2"></div>
        {% endif %}

        <div class="col-12 p-0 mb-2 text-muted">{{ 'sylius.ui.estimate_shipping'|trans }}</div>
        <div class="d-flex justify-content-between">
            <span class="col-9 p-0">
                <select class="form-control mb-1">
                    <option value="1">{{ 'sylius.ui.france_shipping'|trans }}</option>
                    <option value="1">{{ 'sylius.ui.europe_shipping'|trans }}</option>
                    <option value="1">{{ 'sylius.ui.international_shipping'|trans }}</option>
                </select>
            </span>
            <span class="col"></span>
        </div>

        <div class="d-flex justify-content-between">
            <span class="col-9 p-0">
                <select class="form-control my-2">
                    <option value="1">{{ 'sylius.ui.standard_shipping'|trans({'%s': ''}) }}</option>
                    <option value="1">{{ 'sylius.ui.express_shipping'|trans({'%s': ''}) }}</option>
                    <option value="1">{{ 'sylius.ui.relay_shipping'|trans }}</option>
                </select>
            </span>
            <span class="col-3 p-0 d-flex align-items-center justify-content-end">
                {% if cart.shippingTotal > 0 %}
                    {% if cart.getAdjustmentsTotal('shipping') > cart.shippingTotal %}
                        <small><s>{{ money.convertAndFormat(cart.getAdjustmentsTotal('shipping')) }}</s></small>
                    {% endif %}
                    {{ money.convertAndFormat(cart.shippingTotal) }}
                {% else %}
                    <strong class="text-uppercase">{{ 'sylius.ui.free_shipping'|trans }}</strong>
                {% endif %}
            </span>
        </div>

        <div>
            <div class="d-flex flex-row flex-md-column flex-lg-row">
                <span class="text-muted mr-1">{{ 'sylius.ui.standard_shipping'|trans({'%s': '5,90€'}) }}</span> {{ 'sylius.ui.standard_shipping_free'|trans }}
            </div>
            <div class="d-flex flex-row flex-md-column flex-lg-row">
                <span class="text-muted mr-1">{{ 'sylius.ui.express_shipping'|trans({'%s': '14,90€'}) }}</span> {{ 'sylius.ui.express_shipping_free'|trans }}
            </div>
            <div class="d-flex flex-row flex-md-column flex-lg-row">
                <span class="text-muted mr-1">{{ 'sylius.ui.relay_shipping'|trans() }}</span> {{ 'sylius.ui.relay_shipping_free'|trans }}
            </div>
        </div>

        <div class="total-separator w-75 mx-auto mt-3 mb-2"></div>

        <div class="d-flex justify-content-between mt-3">
            <span>
                <strong>{{ 'sylius.ui.order_total'|trans }}</strong><br>
                <span>{{ 'sylius.ui.ttc'|trans }}</span>
            </span>
            <span><strong>{{ money.convertAndFormat(cart.total) }}</strong></span>
        </div>

        {% include '@SyliusShop/Cart/Summary/_checkout.html.twig' with {'hasProductOutOfStock': hasProductOutOfStock} %}
    </div>
</div>
